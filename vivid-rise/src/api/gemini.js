// src/api/gemini.js

// 1. êµ¬ê¸€ ì‹œíŠ¸ ì£¼ì†Œ (CSV ë‚´ë³´ë‚´ê¸° ë§í¬)
const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1C4y3wbFKCYkqHy4ZDhH7AddsTRc3X431mMl6816r9Lw/export?format=csv';

// 2. ë°©ëŒ€í•œ ëª¨ì˜ ë°ì´í„°ë² ì´ìŠ¤ (ê¸°ë³¸ê°’ & ë°±ì—…ìš©)
// ì‹œíŠ¸ ë¡œë”©ì— ì‹¤íŒ¨í•´ë„ ì´ ë°ì´í„°ê°€ ë³´ì—¬ì§‘ë‹ˆë‹¤.
const BASE_DB = {
  'ê°•ë‚¨Â·ì„œì´ˆ': {
    coords: { lat: 37.4980, lng: 127.0277 },
    eat: {
      'í•œì‹': ['ë•€ë•€', 'ë¬´ì›”ì‹íƒ', 'ì²­êµ­ì¥ë°¥', 'ê°ì„±íƒ€ì½”', 'ê°•ë‚¨ë¶ˆë°±'],
      'ì¼ì‹': ['ê³ ì—ëª¬', 'ê°íƒ„ì„±ì‹ ', 'ì˜¤ì œì œ', 'ì¹´ì¸ 8', 'ì€í–‰ê³¨'],
      'ì–‘ì‹': ['ë¯¸ì¦ˆì»¨í…Œì´ë„ˆ', 'ë§ˆì´ˆì‰í”„', 'ì„ì§€ë‹¤ë½ ê°•ë‚¨', 'ë¡¤ë§íŒŒìŠ¤íƒ€', 'ë°”ë¹„ë ˆë“œ'],
      'ì¤‘ì‹': ['ëŒ€ê°€ë°©', 'í™ì½©ë°˜ì 0410', 'ì´ˆì„ ê³¼ì—¬í¬', 'ì¼ì¼í–¥', 'ì°¨ì•Œ'],
      'ë¶„ì‹': ['ë³´ìŠ¬ë³´ìŠ¬', 'ë‚¨ë„ë¶„ì‹', 'ì¥ê¼¬ë°©', 'ì• í”Œí•˜ìš°ìŠ¤', 'ì‹ í¬ìš°ë¦¬ë§Œë‘'],
      'ë©•ì‹œì¹¸': ['ê°ì„±íƒ€ì½”', 'ë‚™ì›íƒ€ì½”', 'ë„ìŠ¤íƒ€ì½”ìŠ¤', 'ì¿ ì°¨ë¼', 'í›Œë¦¬ì˜¤'],
      'ìƒëŸ¬ë“œ': ['í”¼ê·¸ì¸ë”ê°€ë“ ', 'ì•Œë¼ë³´', 'ìŠ¤ìœ—ë°¸ëŸ°ìŠ¤', 'ìƒëŸ¬ë””', 'í¬ë¦¬ìŠ¤í”¼í”„ë ˆì‹œ'],
      'ë””ì €íŠ¸': ['ë…¸í‹°ë“œ ì²­ë‹´', 'ëœë””ìŠ¤ë„ë„›', 'ì•„ìš°ì–´ë² ì´ì»¤ë¦¬', 'ì¸ëµì–´ë°”ì›ƒì»¤í”¼', 'íŠ¸ë¦¬ì˜¤ë“œ']
    },
    do: {
      'íë§Â·ì‚°ì±…': ['ì„ ë¦‰ê³¼ ì •ë¦‰', 'ë„ì‚°ê³µì›', 'ì–‘ì¬ì²œ', 'ë´‰ì€ì‚¬', 'ë°˜í¬í•œê°•ê³µì›'],
      'í™œë™Â·ì´ìƒ‰': ['ë°©íƒˆì¶œ ì œë¡œì›”ë“œ', 'ê°•ë‚¨ í´ë¼ì´ë°', 'ì–‘ê¶ì¹´í˜', 'VRìŠ¤í…Œì´ì…˜', 'ë³¼ë§ì‹œí‹°'],
      'ë¬¸í™”Â·ì „ì‹œ': ['ë§ˆì´ì•„íŠ¸ë®¤ì§€ì—„', 'ì½”ì—‘ìŠ¤ ì•„ì¿ ì•„ë¦¬ì›€', 'í˜„ëŒ€ëª¨í„°ìŠ¤íŠœë””ì˜¤', 'ìŠˆí”¼ê²í™€', 'ì˜ˆìˆ ì˜ì „ë‹¹'],
      'í•«í”ŒÂ·ì‚¬ì§„': ['ë³„ë§ˆë‹¹ë„ì„œê´€', 'ì‹œëª¬ìŠ¤ê·¸ë¡œì„œë¦¬', 'ì  í‹€ëª¬ìŠ¤í„° í•˜ìš°ìŠ¤', 'ë¼ì¸í”„ë Œì¦ˆ', 'ì¹´ì¹´ì˜¤í”„ë Œì¦ˆ']
    }
  },
  'ìš©ì‚°Â·ì´íƒœì›': {
    coords: { lat: 37.5340, lng: 126.9940 },
    eat: {
      'í•œì‹': ['ëª½íƒ„', 'ë‚¨ì˜ëˆ', 'ë°”ë‹¤ì‹ë‹¹', 'ì´íƒœì›í´ë¼ì“° ë‹¨ë°¤'],
      'ì¼ì‹': ['ì˜¤ë ˆë…¸ë¼ë©˜', 'ë©˜ì•¼ì‚°ë‹¤ì´ë©”', 'ìŠ¤ì‹œë¡œ'],
      'ì–‘ì‹': ['ë¶€ìí”¼ì', 'ë‹¤ìš´íƒ€ìš°ë„ˆ í•œë‚¨', 'íŒŒì´í”„ê·¸ë¼ìš´ë“œ'],
      'ì¤‘ì‹': ['ì´íƒœì› ìš°ìœ¡ë¯¸ì—”', 'ìë¦¬', 'ë§ˆë¼í† ë¼'],
      'ë¶„ì‹': ['ì°½í™”ë‹¹', 'ë‚¨ë„ë¶„ì‹', 'í•œë‚¨ë™ ë–¡ë³¶ì´'],
      'ë©•ì‹œì¹¸': ['ë°”í† ìŠ¤', 'í•˜ì‹œì—”ë‹¤', 'ì½”ë ˆì•„ë…¸ìŠ¤ í‚¤ì¹œ'],
      'ìƒëŸ¬ë“œ': ['ìƒëŸ¬ë“œì…€ëŸ¬', 'ë£¨íŠ¸', 'ì™“ì–´ìƒëŸ¬ë“œ'],
      'ë””ì €íŠ¸': ['ì˜¤ì›”ì˜ì¢…', 'íŒ¨ì…˜5', 'ì¨ë¨¸ë ˆì¸']
    },
    do: {
      'íë§Â·ì‚°ì±…': ['ë‚¨ì‚°ê³µì›', 'ìš©ì‚°ê°€ì¡±ê³µì›', 'ì´ì´Œí•œê°•ê³µì›', 'íš¨ì°½ê³µì›'],
      'í™œë™Â·ì´ìƒ‰': ['ì „ìŸê¸°ë…ê´€', 'êµ­ë¦½ì¤‘ì•™ë°•ë¬¼ê´€', 'ìš©ì‚° ë“œë˜ê³¤íìŠ¤íŒŒ'],
      'ë¬¸í™”Â·ì „ì‹œ': ['ë¦¬ì›€ë¯¸ìˆ ê´€', 'ì•„ëª¨ë ˆí¼ì‹œí”½ ë¯¸ìˆ ê´€', 'ë¸”ë£¨ìŠ¤í€˜ì–´'],
      'í•«í”ŒÂ·ì‚¬ì§„': ['í•´ë°©ì´Œ ë£¨í”„íƒ‘', 'ê²½ë¦¬ë‹¨ê¸¸', 'ìš©ë¦¬ë‹¨ê¸¸']
    }
  },
  'ì¢…ë¡œÂ·ì„ì§€ë¡œ': {
    coords: { lat: 37.5704, lng: 126.9922 },
    eat: {
      'í•œì‹': ['ê´‘ì¥ì‹œì¥ ìœ¡íšŒìë§¤ì§‘', 'ì§„ì˜¥í™”í• ë§¤ì›ì¡°ë‹­í•œë§ˆë¦¬', 'ê³„ë¦¼ ë‹­ë„ë¦¬íƒ•'],
      'ì¼ì‹': ['ì¢…ë¡œëˆë¶€ë¦¬', 'ê°“ë´ìŠ¤ì‹œ', 'ì˜¤ì£½ì´ë„¤'],
      'ì–‘ì‹': ['ìµì„ ë™ ì˜¨ì²œì§‘', 'ê²½ì–‘ì‹ 1920', 'ì„ì§€ë‹¤ë½'],
      'ì¤‘ì‹': ['ì•ˆë™ì¥', 'í™ì½©ë°˜ì 0410', 'ì˜¤êµ¬ë°˜ì '],
      'ë¶„ì‹': ['ë‚¨ë„ë¶„ì‹ ìµì„ ', 'ì¢…ë¡œë¶„ì‹', 'ë§›ë‚˜ë¶„ì‹'],
      'ë©•ì‹œì¹¸': ['ì—˜ì ë¼ë˜', 'í›Œë¦¬ì˜¤', 'í† ë§ˆí‹¸ë¡œ'],
      'ìƒëŸ¬ë“œ': ['ì–´ê²Œì¸ë¦¬í”„ë ˆì‰¬', 'íì‚¬ì´ë“œí…Œì´ë¸”', 'ë§ˆì¹˜ë˜ë¹—'],
      'ë””ì €íŠ¸': ['ì²­ìˆ˜ë‹¹', 'ìµì„ ë™ ìŒ€ìƒíšŒ', 'í˜¸ë‘ì´ì»¤í”¼']
    },
    do: {
      'íë§Â·ì‚°ì±…': ['ì²­ê³„ì²œ', 'ë‚™ì‚°ê³µì›', 'ìµì„ ë™ í•œì˜¥ê±°ë¦¬'],
      'í™œë™Â·ì´ìƒ‰': ['ê´‘ì¥ì‹œì¥ ë¨¹ë°©', 'ì¢…ë¡œ ê·€ê¸ˆì†ê±°ë¦¬', 'í•œë³µì²´í—˜'],
      'ë¬¸í™”Â·ì „ì‹œ': ['ëŒ€ë¦¼ë¯¸ìˆ ê´€', 'ì„œìš¸ê³µì˜ˆë°•ë¬¼ê´€', 'êµ­ë¦½í˜„ëŒ€ë¯¸ìˆ ê´€'],
      'í•«í”ŒÂ·ì‚¬ì§„': ['ìµì„ ë™ ê³¨ëª©', 'ì„¸ìš´ìƒê°€', 'í™ì§€ë¡œ ê³¨ëª©']
    }
  },
  'ì„±ìˆ˜Â·ê±´ëŒ€': {
    coords: { lat: 37.5445, lng: 127.0559 },
    eat: {
      'í•œì‹': ['ì†Œë¬¸ë‚œì„±ìˆ˜ê°ìíƒ•', 'í• ë¨¸ë‹ˆì˜ë ˆì‹œí”¼', 'ì„±ìˆ˜ë‹¤ë½'],
      'ì¼ì‹': ['íƒê´‘', 'ë°°í‚¤ìš˜ë°©', 'í˜¸í˜¸ì‹ë‹¹'],
      'ì–‘ì‹': ['íŒ©í”¼', 'ë¬¸í™”ì‹ë‹¹', 'ë‹¤ë¡œë² '],
      'ì¤‘ì‹': ['ì „ìë°©', 'ì¤‘ì•™ê°ì†ê¸°', 'ê±´ëŒ€ ì–‘ê¼¬ì¹˜ê±°ë¦¬'],
      'ë¶„ì‹': ['í•´í”¼ì¹˜ì¦ˆìŠ¤ë§ˆì¼', 'ê¸ˆê¸ˆ', 'ë„ì‚°ë¶„ì‹'],
      'ë©•ì‹œì¹¸': ['ê°“ì‡', 'ì™€í•˜ì¹´', 'í† ë§ˆí‹¸ë¡œ'],
      'ìƒëŸ¬ë“œ': ['ì‡ìƒëŸ¬ë“œ', 'ë¥´ë² ì§€ì™•', 'ìƒëŸ¬ë””'],
      'ë””ì €íŠ¸': ['ì–´ë‹ˆì–¸', 'ëŒ€ë¦¼ì°½ê³ ', 'ë…¸í‹°ë“œ ì„±ìˆ˜']
    },
    do: {
      'íë§Â·ì‚°ì±…': ['ì„œìš¸ìˆ²', 'ëšì„¬í•œê°•ê³µì›', 'ì–´ë¦°ì´ëŒ€ê³µì›'],
      'í™œë™Â·ì´ìƒ‰': ['ì„±ìˆ˜ë™ êµ¬ë‘ê±°ë¦¬', 'ëšì„¬ ìœ ì›ì§€ ì˜¤ë¦¬ë°°', 'ê±´ëŒ€ ë³´ë“œê²Œì„'],
      'ë¬¸í™”Â·ì „ì‹œ': ['ê·¸ë¼ìš´ë“œì‹œì†Œ ì„±ìˆ˜', 'ë””ë®¤ì§€ì—„', 'KT&G ìƒìƒë§ˆë‹¹'],
      'í•«í”ŒÂ·ì‚¬ì§„': ['ë””ì˜¬ ì„±ìˆ˜', 'í”¼ì¹˜ìŠ¤ ë„ì›', 'ì„±ìˆ˜ì—°ë°©']
    }
  },
  'í™ëŒ€Â·ì—°ë‚¨': {
    coords: { lat: 37.5567, lng: 126.9237 },
    eat: {
      'í•œì‹': ['ì—°ë‚¨ì·¨í–¥', 'ìš°ì™€', 'ë¯¸ì˜ë™'],
      'ì¼ì‹': ['í•˜ì¹´íƒ€ë¶„ì½”', 'ì˜¤ë³µìˆ˜ì‚°', 'ì—°ì–´ë¡­ë‹¤'],
      'ì–‘ì‹': ['ë°”ë‹¤íŒŒìŠ¤íƒ€', 'ì—°ë‚¨í…Œë¼ìŠ¤', 'ë¬¸'],
      'ì¤‘ì‹': ['ì¤‘í™”ë³µì¶˜', 'ì—°ë‚¨ë™ íƒ•ìˆ˜ìœ¡', 'í–¥ë¯¸'],
      'ë¶„ì‹': ['ë˜ë³´ê² ì§€ë–¡ë³¶ì´', 'ì¡°í­ë–¡ë³¶ì´', 'ì‚­'],
      'ë©•ì‹œì¹¸': ['êµ¬ìŠ¤í† íƒ€ì½”', 'í›Œë¦¬ì˜¤', 'ê°ì„±íƒ€ì½”'],
      'ìƒëŸ¬ë“œ': ['ê·¸ë¦¬ë„ˆ', 'ë±ƒì‚´ë„ë‘‘', 'ìƒëŸ¬ë””'],
      'ë””ì €íŠ¸': ['ëœë””ìŠ¤ë„ë„›', 'í…Œì¼ëŸ¬ì»¤í”¼', 'ì¹´í˜ ë ˆì´ì–´ë“œ']
    },
    do: {
      'íë§Â·ì‚°ì±…': ['ì—°íŠ¸ëŸ´íŒŒí¬', 'ê²½ì˜ì„ ìˆ²ê¸¸', 'í™ì œì²œ'],
      'í™œë™Â·ì´ìƒ‰': ['í™ëŒ€ ë²„ìŠ¤í‚¹', 'ë°©íƒˆì¶œ ì¹´í˜', 'ì‚¬ê²©ì¥'],
      'ë¬¸í™”Â·ì „ì‹œ': ['KT&G ìƒìƒë§ˆë‹¹', 'í™ëŒ€ ë‚œíƒ€ê·¹ì¥', 'íŠ¸ë¦­ì•„ì´ë®¤ì§€ì—„'],
      'í•«í”ŒÂ·ì‚¬ì§„': ['ì—°ë‚¨ë™ ê³¨ëª©', 'í™ëŒ€ ë†€ì´í„°', 'ë•¡ìŠ¤ë¶ìŠ¤']
    }
  }
};

// 3. ë°ì´í„° ìºì‹± ë° ë¡œë”
let CACHED_DB = null;

// êµ¬ê¸€ ì‹œíŠ¸ íŒŒì‹± ë° ë³‘í•© ë¡œì§
async function getDatabase() {
  if (CACHED_DB) return CACHED_DB;

  try {
    const response = await fetch(GOOGLE_SHEET_URL);
    const text = await response.text();
    
    // ê¸°ë³¸ DB ë³µì‚¬ (Deep Copy)
    const db = JSON.parse(JSON.stringify(BASE_DB));
    const rows = text.split('\n').slice(1); // í—¤ë” ì œì™¸

    rows.forEach(row => {
      // CSV íŒŒì‹±: Region, Category, Name ìˆœì„œë¼ê³  ê°€ì • (ë˜ëŠ” ì‹œíŠ¸ êµ¬ì¡°ì— ë§ì¶° ìˆ˜ì • ê°€ëŠ¥)
      // í˜„ì¬ ì‹œíŠ¸ êµ¬ì¡°ë¥¼ ìœ ì—°í•˜ê²Œ ì½ê¸° ìœ„í•´ ì•„ë˜ì™€ ê°™ì´ ì²˜ë¦¬í•©ë‹ˆë‹¤.
      const cols = row.split(',').map(c => c.trim().replace(/^"|"$/g, ''));
      
      // ì‹œíŠ¸ì˜ ì»¬ëŸ¼ ìˆœì„œê°€ [ì§€ì—­, ì¹´í…Œê³ ë¦¬, ì‹ë‹¹ì´ë¦„] ì´ë¼ê³  ê°€ì •í•  ë•Œ:
      // (ë§Œì•½ ì‹œíŠ¸ê°€ ë‹¤ë¥¸ êµ¬ì¡°ë¼ë©´ ì´ ë¶€ë¶„ì„ ìˆ˜ì •í•˜ë©´ ë©ë‹ˆë‹¤)
      const region = cols[0];   // ì˜ˆ: ê°•ë‚¨Â·ì„œì´ˆ
      const category = cols[1]; // ì˜ˆ: í•œì‹
      const name = cols[2];     // ì˜ˆ: ë•€ë•€

      if (region && category && name && db[region]) {
        if (!db[region].eat[category]) {
          db[region].eat[category] = [];
        }
        // ê¸°ì¡´ ë¦¬ìŠ¤íŠ¸ì— ì—†ìœ¼ë©´ ì¶”ê°€ (ì¤‘ë³µ ë°©ì§€)
        if (!db[region].eat[category].includes(name)) {
          db[region].eat[category].push(name);
        }
      }
    });

    console.log("âœ… êµ¬ê¸€ ì‹œíŠ¸ ë°ì´í„° ë³‘í•© ì™„ë£Œ");
    CACHED_DB = db;
    return db;

  } catch (e) {
    console.warn("ğŸš¨ êµ¬ê¸€ ì‹œíŠ¸ ë¡œë“œ ì‹¤íŒ¨ (ê¸°ë³¸ ë°ì´í„° ì‚¬ìš©):", e);
    return BASE_DB;
  }
}

// 4. ì¢Œí‘œ í”ë“¤ê¸°
const getOffset = () => (Math.random() - 0.5) * 0.005;

// 5. ì¹´í…Œê³ ë¦¬ë³„ ê³ ìœ  ì´ëª¨ì§€ (ì§€ë„ í•€Â·ëª©ë¡ ì•„ì´ì½˜ìš©)
const getCategoryEmoji = (cat) => {
  // ì˜¤ëŠ˜ ë­ ë¨¹ì§€: í•œì‹Â·ì¼ì‹Â·ì¤‘ì‹Â·ì–‘ì‹Â·ë¶„ì‹Â·ë©•ì‹œì¹¸Â·ìƒëŸ¬ë“œÂ·ë””ì €íŠ¸
  if (cat === 'í•œì‹') return 'ğŸš';
  if (cat === 'ì¼ì‹') return 'ğŸ£';
  if (cat === 'ì¤‘ì‹') return 'ğŸ¥Ÿ';
  if (cat === 'ì–‘ì‹') return 'ğŸ”';
  if (cat === 'ë¶„ì‹') return 'ğŸ¥˜';
  if (cat === 'ë©•ì‹œì¹¸') return 'ğŸŒ®';
  if (cat === 'ìƒëŸ¬ë“œ') return 'ğŸ¥—';
  if (cat === 'ë””ì €íŠ¸') return 'ğŸ°';
  // ì˜¤ëŠ˜ ë­ í•˜ì§€: íë§Â·ì‚°ì±…, í™œë™Â·ì´ìƒ‰, ë¬¸í™”Â·ì „ì‹œ, í•«í”ŒÂ·ì‚¬ì§„
  if (cat === 'íë§Â·ì‚°ì±…') return 'ğŸŒ¿';
  if (cat === 'í™œë™Â·ì´ìƒ‰') return 'ğŸ›¹';
  if (cat === 'ë¬¸í™”Â·ì „ì‹œ') return 'ğŸ¨';
  if (cat === 'í•«í”ŒÂ·ì‚¬ì§„') return 'ğŸ“¸';
  return 'âœ¨';
};

// 6. ê³µì§€ì‚¬í•­
const NOTICES = [
  "ğŸ“¢ ì¬ë£Œ ì†Œì§„ ì‹œ ì¡°ê¸° ë§ˆê°ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
  "ğŸš— ì£¼ì°¨ ê³µê°„ì´ í˜‘ì†Œí•˜ë‹ˆ ëŒ€ì¤‘êµí†µì„ ì´ìš©í•´ì£¼ì„¸ìš”.",
  "â° ì›¨ì´íŒ…ì´ ìˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ ì˜ˆì•½ ì¶”ì²œë“œë ¤ìš”!",
  "ğŸ¶ ë°˜ë ¤ë™ë¬¼ ë™ë°˜ ê°€ëŠ¥í•œ ê³µê°„ì…ë‹ˆë‹¤.",
  "ğŸ‰ ë„¤ì´ë²„ ë¦¬ë·° ì‘ì„± ì‹œ ìŒë£Œ ì„œë¹„ìŠ¤!"
];

// ì¹´í…Œê³ ë¦¬ë³„ ëŒ€í‘œ ë©”ë‰´ (í•€ í´ë¦­ ì‹œ í•˜ë‹¨ ì‹œíŠ¸ì— í‘œì‹œ)
const REPRESENTATIVE_MENUS = {
  'í•œì‹': ['ê¹€ì¹˜ì°Œê°œ', 'ë¶ˆê³ ê¸°', 'ë¹„ë¹”ë°¥', 'ëœì¥ì°Œê°œ', 'ì œìœ¡ë³¶ìŒ'],
  'ì¼ì‹': ['ì´ˆë°¥', 'ë¼ë©˜', 'ëˆì¹´ì¸ ', 'ìš°ë™', 'ì˜¤ë§ˆì¹´ì„¸'],
  'ì¤‘ì‹': ['ì§œì¥ë©´', 'ì§¬ë½•', 'íƒ•ìˆ˜ìœ¡', 'ê¹í’ê¸°', 'ìœ ë‹ˆì§œì¥'],
  'ì–‘ì‹': ['íŒŒìŠ¤íƒ€', 'ìŠ¤í…Œì´í¬', 'í”¼ì', 'ë¦¬ì¡°ë˜', 'ë²„ê±°'],
  'ë¶„ì‹': ['ë–¡ë³¶ì´', 'ìˆœëŒ€', 'íŠ€ê¹€', 'ë¼ë©´', 'ê¹€ë°¥'],
  'ë©•ì‹œì¹¸': ['íƒ€ì½”', 'ë¶€ë¦¬ë˜', 'ë‚˜ì´ˆ', 'í€˜ì‚¬ë””ì•„', 'íŒ”ë ˆíƒ€'],
  'ìƒëŸ¬ë“œ': ['ì‹œì €ìƒëŸ¬ë“œ', 'ê·¸ë¦­ìƒëŸ¬ë“œ', 'ì½¥ìƒëŸ¬ë“œ', 'ì—°ì–´ìƒëŸ¬ë“œ'],
  'ë””ì €íŠ¸': ['ì¼€ì´í¬', 'ì•„ì´ìŠ¤í¬ë¦¼', 'ì™€í”Œ', 'ë§ˆì¹´ë¡±', 'ë¸Œë¼ìš°ë‹ˆ']
};
const pickRepresentativeMenu = (category) => {
  let menus = REPRESENTATIVE_MENUS[category];
  if (!menus || menus.length === 0) {
    const all = Object.values(REPRESENTATIVE_MENUS).flat();
    menus = all.length ? all : [];
  }
  if (menus.length === 0) return '';
  const count = Math.random() > 0.5 ? 2 : 3;
  return menus.sort(() => 0.5 - Math.random()).slice(0, count).join(', ');
};

// ì§€ì—­ í‚¤ í†µì¼ (SelectëŠ” location, Homeì€ region ì „ë‹¬)
const normalizeRegionKey = (key) => {
  if (!key) return 'ê°•ë‚¨Â·ì„œì´ˆ';
  const map = {
    'ê°•ë‚¨Â·ì„œì´ˆÂ·ì†¡íŒŒ': 'ê°•ë‚¨Â·ì„œì´ˆ', 'ìš©ì‚°Â·ë§ˆí¬Â·ì„œëŒ€ë¬¸': 'ìš©ì‚°Â·ì´íƒœì›',
    'ì¢…ë¡œÂ·ë™ëŒ€ë¬¸': 'ì¢…ë¡œÂ·ì„ì§€ë¡œ', 'ì„±ìˆ˜Â·ê±´ëŒ€ì…êµ¬': 'ì„±ìˆ˜Â·ê±´ëŒ€', 'ê´€ì•…Â·ì˜ë“±í¬': 'ê°•ë‚¨Â·ì„œì´ˆ'
  };
  return map[key] || key;
};

// ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ê²€ìƒ‰ ì‹œ í•´ë‹¹ ì§€ì—­ ì§€ë„ê°€ ë‚˜ì˜¤ë„ë¡ í•˜ëŠ” í‚¤ì›Œë“œ (í™ëŒ€â†’í™ëŒ€, ì„ì§€ë¡œâ†’ì¢…ë¡œ ë“±)
const getNaverPlaceRegionHint = (regionKey) => {
  const hints = {
    'ê°•ë‚¨Â·ì„œì´ˆ': 'ê°•ë‚¨',
    'ìš©ì‚°Â·ì´íƒœì›': 'ì´íƒœì›',
    'ì¢…ë¡œÂ·ì„ì§€ë¡œ': 'ì¢…ë¡œ',
    'ì„±ìˆ˜Â·ê±´ëŒ€': 'ì„±ìˆ˜',
    'í™ëŒ€Â·ì—°ë‚¨': 'í™ëŒ€'
  };
  return hints[regionKey] || regionKey.split('Â·')[0] || regionKey;
};

// 7. ë©”ì¸ í•¨ìˆ˜ (ì™¸ë¶€ì—ì„œ í˜¸ì¶œ)
export async function fetchRecommendations(params) {
  // 1. DB ë¡œë“œ (ì‹œíŠ¸ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë®ì–´ì”Œì›Œì§)
  const db = await getDatabase();

  const rawRegion = params.region || params.location;
  const regionKey = normalizeRegionKey(rawRegion) || 'ê°•ë‚¨Â·ì„œì´ˆ';
  const mode = params.mode || 'eat'; // 'eat' ë˜ëŠ” 'do'
  const category = (mode === 'eat' ? params.menu : params.mood) || 'ëœë¤';

  console.log(`ğŸ” ê²€ìƒ‰: [${regionKey}] ì§€ì—­ì˜ [${category}] (${mode})`);

  let regionData = db[regionKey];
  if (!regionData) {
    console.warn(`ğŸš¨ ì§€ì—­ ë°ì´í„° ì—†ìŒ: ${regionKey} -> ê°•ë‚¨ìœ¼ë¡œ ëŒ€ì²´`);
    regionData = db['ê°•ë‚¨Â·ì„œì´ˆ'];
  }

  // 2. ì¹´í…Œê³ ë¦¬ ì„ íƒ ë¡œì§ (ì„ íƒí•œ ë©”ë‰´ê°€ ì—¬ê¸°ì„œ í•„í„°ë§ë¨)
  const categoryMap = regionData[mode] || {};
  let placeNames = categoryMap[category];

  // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì— ì‹ë‹¹ì´ ì—†ê±°ë‚˜ 'ëœë¤'ì¸ ê²½ìš°
  if (!placeNames || placeNames.length === 0) {
    const allPlaces = Object.values(categoryMap).flat();
    placeNames = allPlaces.sort(() => 0.5 - Math.random()).slice(0, 5);
  }

  const placeRegionHint = getNaverPlaceRegionHint(regionKey);

  // 3. ê²°ê³¼ ìƒì„± (ì¢Œí‘œëŠ” ì§€ì—­ ì¤‘ì‹¬ ê¸°ì¤€, ì£¼ì†ŒëŠ” ì§€ì—­ìœ¼ë¡œ í†µì¼í•´ ì§€ë„ì™€ ì¼ì¹˜)
  const results = placeNames.slice(0, 3).map((name, index) => {
    const isWaiting = Math.random() > 0.4;
    const randomNotice = NOTICES[Math.floor(Math.random() * NOTICES.length)];
    const address = `${regionKey} ì§€ì—­ (ì •í™•í•œ ìœ„ì¹˜ëŠ” ë„¤ì´ë²„ ì§€ë„ì—ì„œ í™•ì¸)`;
    // ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤: ê°€ê²Œëª… + ì§€ì—­ í‚¤ì›Œë“œ(í™ëŒ€, ê°•ë‚¨ ë“±)ë¡œ ê²€ìƒ‰í•´ í•´ë‹¹ ì§€ì—­ ì§€ë„ê°€ ë‚˜ì˜¤ë„ë¡ ì—°ê²°
    const naverSearchQuery = `${name} ${placeRegionHint}`;
    const naverUrl = `https://m.place.naver.com/place/list?query=${encodeURIComponent(naverSearchQuery)}`;

    const representativeMenu = mode === 'eat' ? pickRepresentativeMenu(category) : '';

    return {
      id: index + 1,
      name: name,
      description: `${category} í•«í”Œë ˆì´ìŠ¤`,
      lat: regionData.coords.lat + getOffset(),
      lng: regionData.coords.lng + getOffset(),
      emoji: getCategoryEmoji(category),
      status: isWaiting ? "ì›¨ì´íŒ… ìˆìŒ" : "ì…ì¥ ê°€ëŠ¥",
      statusColor: isWaiting ? "red" : "green",
      notice: randomNotice,
      naverUrl,
      hours: "11:00 - 22:00",
      address,
      time: ["12:00", "15:00", "18:00"][index],
      tag: category,
      representativeMenu
    };
  });

  return new Promise(resolve => setTimeout(() => resolve(results), 600));
}

// (lat,lng)ì—ì„œ ê°€ì¥ ê°€ê¹Œìš´ ì§€ì—­ í‚¤ ë°˜í™˜
function getClosestRegionKey(db, lat, lng) {
  if (lat == null || lng == null) return 'ê°•ë‚¨Â·ì„œì´ˆ';
  let bestKey = 'ê°•ë‚¨Â·ì„œì´ˆ';
  let bestDist = Infinity;
  for (const [key, data] of Object.entries(db)) {
    const c = data.coords;
    if (!c?.lat || c?.lng == null) continue;
    const dist = (c.lat - lat) ** 2 + (c.lng - lng) ** 2;
    if (dist < bestDist) {
      bestDist = dist;
      bestKey = key;
    }
  }
  return bestKey;
}

/**
 * ì°œí•œ ì¥ì†Œ ê·¼ì²˜ì˜ ë°˜ëŒ€ ìœ í˜• 1ê³³ ì¶”ì²œ (ë‚˜ì˜ ì°œí•œ ì½”ìŠ¤ìš©)
 * @param {{ lat: number, lng: number, type: 'eat' | 'do' }} params - ì°œí•œ ì¥ì†Œì˜ ì¢Œí‘œì™€ ìœ í˜•
 * @returns {Promise<{ name: string, emoji: string, tag: string, naverUrl: string, solo_difficulty_level: number }>}
 */
export async function fetchNearbyRecommendation(params) {
  const db = await getDatabase();
  const { lat, lng, type } = params || {};
  const wantType = type === 'do' ? 'do' : 'eat';
  const regionKey = getClosestRegionKey(db, lat, lng);
  const regionData = db[regionKey] || db['ê°•ë‚¨Â·ì„œì´ˆ'];
  const categoryMap = regionData[wantType] || {};
  const allNames = Object.values(categoryMap).flat();
  const placeNames = allNames.length > 0 ? allNames : (wantType === 'eat' ? ['ê·¼ì²˜ ë§›ì§‘'] : ['ê·¼ì²˜ í™œë™']);
  const name = placeNames[Math.floor(Math.random() * placeNames.length)];
  const category = Object.entries(categoryMap).find(([, arr]) => arr.includes(name))?.[0] || 'ì¶”ì²œ';
  const placeRegionHint = getNaverPlaceRegionHint(regionKey);
  const naverUrl = `https://m.place.naver.com/place/list?query=${encodeURIComponent(`${name} ${placeRegionHint}`)}`;
  return new Promise((resolve) => {
    setTimeout(
      () =>
        resolve({
          name,
          emoji: getCategoryEmoji(category),
          tag: category,
          naverUrl,
          solo_difficulty_level: 1,
        }),
      400
    );
  });
}